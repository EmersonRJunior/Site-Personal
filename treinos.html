<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gerenciador de Treinos - Recuperação & Hipertrofia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc; 
            overflow-x: hidden; /* Evita scroll horizontal durante o swipe */
            touch-action: pan-y; /* Permite scroll vertical mas gerenciaremos o horizontal */
        }
        
        .card-enter { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .tab-active { border-bottom: 3px solid #2563eb; color: #2563eb; }
        #modal-montar, #modal-dia { z-index: 9999; }
        
        .notes-area { 
            white-space: pre-wrap; 
            word-wrap: break-word; 
            overflow-wrap: break-word;
            max-width: 100%;
        }

        .clickable-card {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .clickable-card:hover {
            border-color: #3b82f6; 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        #content-dia .clickable-card:hover {
            border-color: #10b981; 
        }

        /* Transição suave entre abas */
        .tab-content {
            transition: opacity 0.2s ease-in-out;
        }
        .fade-out { opacity: 0; }
        .fade-in { opacity: 1; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="app" class="max-w-4xl mx-auto">
        <!-- Cabeçalho -->
        <header class="mb-8 border-b border-slate-200">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h1 class="text-3xl font-bold text-slate-800">Sistema de Treinos</h1>
                    <div id="connStatus" class="text-[10px] font-mono mt-1 px-2 py-0.5 rounded bg-slate-100 inline-block uppercase tracking-wider text-slate-500">Conectando...</div>
                </div>
            </div>
            <nav class="flex gap-8">
                <button onclick="switchTab('montar')" id="tab-montar" class="pb-3 font-semibold text-slate-500 hover:text-slate-700 transition-all tab-active">Treinos a Montar</button>
                <button onclick="switchTab('dia')" id="tab-dia" class="pb-3 font-semibold text-slate-500 hover:text-slate-700 transition-all">Treino do Dia</button>
            </nav>
        </header>

        <!-- Container das Abas -->
        <div id="tab-container" class="tab-content">
            <!-- ABA 1: TREINOS A MONTAR -->
            <main id="content-montar">
                <div class="flex justify-between items-center mb-6">
                    <div class="bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                        <span class="text-slate-500 text-xs uppercase font-bold">Fila de Espera:</span>
                        <span id="countPending" class="text-xl font-bold text-blue-600 ml-2">0</span>
                    </div>
                    <button onclick="openModal('montar')" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-semibold shadow flex items-center gap-2 transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        Novo Aluno
                    </button>
                </div>
                <div id="studentList" class="grid grid-cols-1 gap-4"></div>
                <div id="emptyStateMontar" class="hidden text-center py-20 text-slate-400">Nenhum aluno aguardando montagem.</div>
            </main>

            <!-- ABA 2: TREINO DO DIA -->
            <main id="content-dia" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-semibold text-slate-700">Prescrição da Sessão</h2>
                    <button onclick="openModal('dia')" class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2 rounded-lg font-semibold shadow flex items-center gap-2 transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        Novo Aluno
                    </button>
                </div>
                <div id="dailyList" class="grid grid-cols-1 gap-4"></div>
                <div id="emptyStateDia" class="hidden text-center py-20 text-slate-400">Nenhum treino prescrito para hoje.</div>
            </main>
        </div>
    </div>

    <!-- MODAL: ABA 1 -->
    <div id="modal-montar" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden card-enter">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <h2 class="text-xl font-bold text-slate-800">Fila de Montagem</h2>
                <button onclick="closeModal('montar')" class="text-slate-400 hover:text-slate-600">✕</button>
            </div>
            <form id="form-montar" class="p-6 space-y-4">
                <input type="hidden" id="editId-montar">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Nome do Aluno</label>
                    <input type="text" id="name-montar" required class="w-full border border-slate-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Academia</label>
                        <input type="text" id="gym-montar" required class="w-full border border-slate-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Matrícula</label>
                        <input type="text" id="enrollment-montar" class="w-full border border-slate-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Obs. Clínicas</label>
                    <textarea id="obs-montar" rows="3" class="w-full border border-slate-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-colors">Salvar Alterações</button>
            </form>
        </div>
    </div>

    <!-- MODAL: ABA 2 -->
    <div id="modal-dia" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden card-enter">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <h2 class="text-xl font-bold text-slate-800">Prescrever Treino</h2>
                <button onclick="closeModal('dia')" class="text-slate-400 hover:text-slate-600">✕</button>
            </div>
            <form id="form-dia" class="p-6 space-y-4">
                <input type="hidden" id="editId-dia">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Aluno</label>
                        <input type="text" id="name-dia" required class="w-full border border-slate-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Grupo Muscular</label>
                        <input type="text" id="muscle-dia" required class="w-full border border-slate-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Descrição / Notas</label>
                    <textarea id="notes-dia" rows="10" required class="w-full border border-slate-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Exercícios e séries..."></textarea>
                </div>
                <button type="submit" class="w-full bg-emerald-600 text-white font-bold py-3 rounded-lg hover:bg-emerald-700 transition-colors">Salvar Treino</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDa-kFAP_jyErQVBeouZXppWEBVlE6SluI",
            authDomain: "montadordetreinos.firebaseapp.com",
            projectId: "montadordetreinos",
            storageBucket: "montadordetreinos.firebasestorage.app",
            messagingSenderId: "282706566428",
            appId: "1:282706566428:web:0a0468db3b4d38b44ceed9",
            measurementId: "G-GK8ZDD5SE1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "gerenciador-treinos-v1";

        let currentUser = null;
        let students = [];
        let dailyWorkouts = [];
        let currentActiveTab = 'montar';

        // Lógica de Swipe (Deslizar)
        let touchstartX = 0;
        let touchendX = 0;

        function handleGesture() {
            const threshold = 70; // Sensibilidade do deslize
            if (touchendX < touchstartX - threshold) {
                // Deslizou para a esquerda -> Aba Treino do Dia
                if (currentActiveTab === 'montar') switchTab('dia');
            }
            if (touchendX > touchstartX + threshold) {
                // Deslizou para a direita -> Aba Treinos a Montar
                if (currentActiveTab === 'dia') switchTab('montar');
            }
        }

        document.addEventListener('touchstart', e => {
            touchstartX = e.changedTouches[0].screenX;
        }, false);

        document.addEventListener('touchend', e => {
            touchendX = e.changedTouches[0].screenX;
            // Só ativa o swipe se não houver um modal aberto
            const isModalOpen = !document.getElementById('modal-montar').classList.contains('hidden') || 
                                !document.getElementById('modal-dia').classList.contains('hidden');
            if (!isModalOpen) handleGesture();
        }, false);

        window.switchTab = (tab) => {
            if (currentActiveTab === tab) return;
            
            const container = document.getElementById('tab-container');
            container.classList.add('fade-out');

            setTimeout(() => {
                currentActiveTab = tab;
                document.getElementById('content-montar').classList.toggle('hidden', tab !== 'montar');
                document.getElementById('content-dia').classList.toggle('hidden', tab !== 'dia');
                document.getElementById('tab-montar').classList.toggle('tab-active', tab === 'montar');
                document.getElementById('tab-dia').classList.toggle('tab-active', tab === 'dia');
                
                container.classList.remove('fade-out');
                container.classList.add('fade-in');
            }, 150);
        };

        window.openModal = (type) => {
            document.getElementById(`form-${type}`).reset();
            document.getElementById(`editId-${type}`).value = '';
            document.getElementById(`modal-${type}`).classList.replace('hidden', 'flex');
        };
        window.closeModal = (type) => document.getElementById(`modal-${type}`).classList.replace('flex', 'hidden');

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('connStatus').innerText = "Nuvem Ativa";
                document.getElementById('connStatus').className = "text-[10px] font-mono mt-1 px-2 py-0.5 rounded bg-green-100 text-green-700 inline-block uppercase tracking-wider";
                setupListeners(user.uid);
            } else {
                signInAnonymously(auth);
            }
        });

        function setupListeners(userId) {
            onSnapshot(collection(db, 'artifacts', appId, 'users', userId, 'students'), (snap) => {
                students = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderMontar();
            });
            onSnapshot(collection(db, 'artifacts', appId, 'users', userId, 'daily_workouts'), (snap) => {
                dailyWorkouts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderDia();
            });
        }

        document.getElementById('form-montar').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('editId-montar').value;
            const data = {
                name: document.getElementById('name-montar').value,
                gym: document.getElementById('gym-montar').value,
                enrollment: document.getElementById('enrollment-montar').value,
                observations: document.getElementById('obs-montar').value,
                createdAt: id ? students.find(s => s.id === id).createdAt : new Date().toISOString()
            };
            const col = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'students');
            id ? await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'students', id), data) : await addDoc(col, data);
            closeModal('montar');
        };

        document.getElementById('form-dia').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('editId-dia').value;
            const data = {
                studentName: document.getElementById('name-dia').value,
                muscleGroup: document.getElementById('muscle-dia').value,
                notes: document.getElementById('notes-dia').value,
                createdAt: id ? dailyWorkouts.find(w => w.id === id).createdAt : new Date().toISOString()
            };
            const col = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'daily_workouts');
            id ? await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'daily_workouts', id), data) : await addDoc(col, data);
            closeModal('dia');
        };

        window.deleteItem = async (type, id) => {
            const colName = type === 'montar' ? 'students' : 'daily_workouts';
            await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, colName, id));
        };

        window.clearContent = async (e, id) => {
            e.stopPropagation();
            await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'daily_workouts', id), {
                notes: ""
            });
        };

        window.confirmDelete = async (e, type, id) => {
            e.stopPropagation();
            await deleteItem(type, id);
        };

        window.editMontar = (id) => {
            const s = students.find(i => i.id === id);
            if(!s) return;
            document.getElementById('editId-montar').value = s.id;
            document.getElementById('name-montar').value = s.name;
            document.getElementById('gym-montar').value = s.gym;
            document.getElementById('enrollment-montar').value = s.enrollment || '';
            document.getElementById('obs-montar').value = s.observations || '';
            document.getElementById(`modal-montar`).classList.replace('hidden', 'flex');
        };

        window.editDia = (id) => {
            const w = dailyWorkouts.find(i => i.id === id);
            if(!w) return;
            document.getElementById('editId-dia').value = w.id;
            document.getElementById('name-dia').value = w.studentName;
            document.getElementById('muscle-dia').value = w.muscleGroup;
            document.getElementById('notes-dia').value = w.notes;
            document.getElementById(`modal-dia`).classList.replace('hidden', 'flex');
        };

        function renderMontar() {
            const list = document.getElementById('studentList');
            list.innerHTML = '';
            document.getElementById('countPending').innerText = students.length;
            document.getElementById('emptyStateMontar').classList.toggle('hidden', students.length > 0);
            students.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(s => {
                const div = document.createElement('div');
                div.className = "bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex justify-between items-center card-enter clickable-card";
                div.onclick = () => editMontar(s.id);
                div.innerHTML = `
                    <div class="flex-1 overflow-hidden">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-slate-800 truncate">${s.name}</span>
                            <span class="text-[9px] bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded uppercase font-bold shrink-0">${s.gym}</span>
                        </div>
                        <p class="text-xs text-slate-500 mt-1 truncate">${s.observations || '<span class="italic opacity-50">Sem notas clínicas...</span>'}</p>
                    </div>
                    <button onclick="confirmDelete(event, 'montar', '${s.id}')" class="text-slate-300 hover:text-green-500 p-2 shrink-0 transition-colors" title="Concluir/Remover">
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                    </button>
                `;
                list.appendChild(div);
            });
        }

        function renderDia() {
            const list = document.getElementById('dailyList');
            list.innerHTML = '';
            document.getElementById('emptyStateDia').classList.toggle('hidden', dailyWorkouts.length > 0);
            dailyWorkouts.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(w => {
                const div = document.createElement('div');
                div.className = "bg-white p-5 rounded-2xl border border-slate-200 shadow-sm card-enter mb-6 overflow-hidden clickable-card";
                div.onclick = () => editDia(w.id);
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-4 gap-2">
                        <div class="overflow-hidden">
                            <h3 class="text-xl font-bold text-slate-800 truncate">${w.studentName}</h3>
                            <span class="inline-block bg-emerald-100 text-emerald-700 text-[10px] font-bold px-2 py-0.5 rounded uppercase mt-1">Foco: ${w.muscleGroup}</span>
                        </div>
                        <div class="flex gap-2 shrink-0">
                            <button onclick="clearContent(event, '${w.id}')" class="text-slate-400 hover:text-amber-500 p-1 transition-colors" title="Limpar notas">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            </button>
                            <button onclick="confirmDelete(event, 'dia', '${w.id}')" class="text-slate-300 hover:text-red-500 p-1 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </button>
                        </div>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 text-sm text-slate-700 leading-relaxed overflow-hidden">
                        <div class="notes-area">${w.notes || '<span class="text-slate-300 italic">Toque para adicionar o treino...</span>'}</div>
                    </div>
                `;
                list.appendChild(div);
            });
        }
    </script>
</body>
</html>

